# LightBoard - План разработки

Этот документ описывает дорожную карту реализации для построения полного приложения LightBoard от текущей минимальной настройки до полнофункционального дашборда визуализации данных.

## Текущий статус ✅

- [x] Базовая структура проекта
- [x] Docker окружение для разработки
- [x] Бэкенд: Spring Boot с hello endpoint
- [x] Фронтенд: React с базовым UI
- [x] Подключение к базе данных PostgreSQL
- [x] Горячая перезагрузка для обоих сервисов

---

## Фаза 1: Схема базы данных и модели

### Задачи бэкенда

- [ ] **Создание JPA сущностей**
  - [ ] `Dataset.java` - Основная сущность датасета
  - [ ] `DatasetColumn.java` - Сущность метаданных колонок
  - [ ] `UploadJob.java` - Сущность отслеживания асинхронных задач
  - [ ] Добавить правильные связи и индексы

- [ ] **Создание репозиториев**
  - [ ] `DatasetRepository` (extends JpaRepository)
  - [ ] `DatasetColumnRepository`
  - [ ] `UploadJobRepository`
  - [ ] `DynamicQueryRepository` (используя JdbcTemplate для динамических таблиц)

- [ ] **Инициализация базы данных**
  - [ ] Добавить Flyway или Liquibase для миграций
  - [ ] Создать начальные скрипты миграций схемы
  - [ ] Добавить индексы базы данных для производительности

### Ожидаемый результат
Схема базы данных с таблицами `datasets`, `dataset_columns` и `upload_jobs` готова к использованию.

---

## Фаза 2: Загрузка и обработка CSV

### Задачи бэкенда

- [ ] **Контроллер загрузки файлов**
  - [ ] Эндпоинт `POST /api/datasets/upload`
  - [ ] Обработка multipart файлов
  - [ ] Валидация размера файла (рекомендуется макс. 100MB)
  - [ ] Временное хранение файлов

- [ ] **Сервис обработки CSV**
  - [ ] `CsvProcessingService.java` - Основная логика обработки
  - [ ] Добавить зависимость OpenCSV в build.gradle
  - [ ] Определение кодировки (UTF-8, Windows-1251 и т.д.)
  - [ ] Определение разделителя (запятая, точка с запятой, табуляция)
  - [ ] Потоковый парсер для больших файлов

- [ ] **Логика определения типов**
  - [ ] Анализ примеров колонок (первые N строк)
  - [ ] Определение NUMERIC (целые числа, дробные)
  - [ ] Определение DATE (yyyy-MM-dd)
  - [ ] Определение DATETIME (yyyy-MM-dd HH:mm:ss)
  - [ ] Определение BOOLEAN (true/false, yes/no, 1/0)
  - [ ] Определение CATEGORICAL (ограниченное количество уникальных значений)
  - [ ] По умолчанию TEXT для всего остального
  - [ ] Сопоставление обнаруженных типов с типами PostgreSQL

- [ ] **Динамическое создание таблиц**
  - [ ] Генерация имени таблицы: `data_<uuid>`
  - [ ] Создание таблицы с обнаруженными типами колонок
  - [ ] Добавление индексов на колонки дат и категорий
  - [ ] Обработка специальных символов в именах колонок

- [ ] **Асинхронная обработка**
  - [ ] Настроить `@EnableAsync` и `TaskExecutor`
  - [ ] `@Async` метод для фоновой обработки
  - [ ] Отслеживание прогресса в таблице `upload_jobs`
  - [ ] Обработка ошибок и логика отката
  - [ ] Пакетные вставки (1000 строк за раз)

- [ ] **Эндпоинт статуса задачи**
  - [ ] `GET /api/upload/{jobId}/status`
  - [ ] Возврат прогресса, количества строк, ошибок
  - [ ] Обработка состояний QUEUED/PROCESSING/COMPLETED/FAILED

### Задачи фронтенда

- [ ] **Компонент загрузки**
  - [ ] `CSVUploader.tsx` - Drag & drop или выбор файла
  - [ ] Валидация файла (только CSV, проверка размера)
  - [ ] Прогресс-бар загрузки
  - [ ] Отображение ошибок

- [ ] **Страница прогресса загрузки**
  - [ ] Роут: `/upload/:jobId`
  - [ ] Опрос эндпоинта статуса каждые 2 секунды
  - [ ] Показ прогресс-бара и статистики
  - [ ] Редирект на просмотр датасета при завершении
  - [ ] Отображение ошибок при сбое

- [ ] **Интеграция React Query**
  - [ ] Хук `useUpload` - мутация загрузки
  - [ ] Хук `useUploadStatus` - опрос статуса задачи
  - [ ] Автоматическая инвалидация запросов при завершении

### Ожидаемый результат
Пользователи могут загружать CSV файлы, видеть прогресс в реальном времени, и данные автоматически сохраняются в PostgreSQL.

---

## Фаза 3: Управление датасетами

### Задачи бэкенда

- [ ] **Эндпоинты датасетов**
  - [ ] `GET /api/datasets` - Список всех датасетов (с пагинацией)
  - [ ] `GET /api/datasets/{id}` - Получение деталей датасета
  - [ ] `GET /api/datasets/{id}/columns` - Получение метаданных колонок
  - [ ] `GET /api/datasets/{id}/preview` - Получение первых N строк (по умолчанию 100)
  - [ ] `DELETE /api/datasets/{id}` - Удаление датасета и динамической таблицы

- [ ] **Сервис датасетов**
  - [ ] `DatasetService.java` - Бизнес-логика
  - [ ] Получение датасетов со статистикой
  - [ ] Предпросмотр данных из динамических таблиц
  - [ ] Безопасное удаление (удаление динамической таблицы + метаданных)

- [ ] **DTO**
  - [ ] `DatasetResponse.java`
  - [ ] `DatasetColumnResponse.java`
  - [ ] `DatasetPreviewResponse.java`
  - [ ] `DatasetListResponse.java` (с пагинацией)

### Задачи фронтенда

- [ ] **Страница списка датасетов**
  - [ ] Роут: `/datasets`
  - [ ] Компонент DatasetCard для каждого датасета
  - [ ] Функциональность поиска/фильтрации
  - [ ] Сортировка по дате, имени, размеру
  - [ ] Диалог подтверждения удаления

- [ ] **Страница деталей датасета**
  - [ ] Отображение метаданных (строки, колонки, дата загрузки)
  - [ ] Отображение информации о колонках с типами
  - [ ] Таблица предпросмотра с первыми 100 строками
  - [ ] Пагинация для предпросмотра
  - [ ] Кнопка "Создать дашборд"

- [ ] **Хуки React Query**
  - [ ] `useDatasets` - получение всех датасетов
  - [ ] `useDataset` - получение одного датасета
  - [ ] `useDatasetPreview` - получение данных предпросмотра
  - [ ] `useDeleteDataset` - мутация удаления

### Ожидаемый результат
Пользователи могут просматривать загруженные датасеты, видеть предпросмотр и управлять своими данными.

---

## Фаза 4: WebSocket обновления в реальном времени

### Задачи бэкенда

- [ ] **Конфигурация WebSocket**
  - [ ] Добавить зависимость Spring WebSocket
  - [ ] `WebSocketConfig.java` - конфигурация STOMP
  - [ ] Настроить message broker
  - [ ] Установить разрешённые origins (CORS)

- [ ] **Интеграция WebSocket**
  - [ ] Отправка обновлений прогресса через WebSocket
  - [ ] Топик: `/topic/upload/{jobId}`
  - [ ] Рассылка при завершении каждого батча
  - [ ] Отправка финального статуса при завершении задачи

### Задачи фронтенда

- [ ] **WebSocket клиент**
  - [ ] Установить библиотеку STOMP.js
  - [ ] Хук `useWebSocket`
  - [ ] Подписка на топик прогресса загрузки
  - [ ] Обновление UI при получении сообщений
  - [ ] Fallback на опрос при сбое WS

### Ожидаемый результат
Обновления прогресса в реальном времени без опроса (с опросом как резервный вариант).

---

## Фаза 5: API данных для графиков

### Задачи бэкенда

- [ ] **Эндпоинт данных графиков**
  - [ ] `POST /api/charts/data` - Универсальный эндпоинт данных графиков
  - [ ] DTO запроса с типом графика, колонками, фильтрами, агрегацией

- [ ] **Сервис данных графиков**
  - [ ] `ChartDataService.java` - Построитель запросов
  - [ ] Валидация типа графика и совместимости колонок
  - [ ] Построение динамического SQL для разных типов графиков
  - [ ] Поддержка WHERE фильтров (диапазон дат, категории, числовой диапазон)
  - [ ] Поддержка GROUP BY для агрегаций
  - [ ] Поддержка группировки по времени (день, неделя, месяц)

- [ ] **Сервис сэмплирования**
  - [ ] `SamplingService.java` - Редукция данных
  - [ ] Даунсэмплинг больших датасетов (>1000 точек)
  - [ ] Алгоритм LTTB или простая группировка
  - [ ] Сохранение формы и трендов данных

- [ ] **Функции агрегации**
  - [ ] SUM, AVG, COUNT, MIN, MAX
  - [ ] Поддержка множественных серий
  - [ ] Правильная обработка NULL значений

- [ ] **DTO**
  - [ ] `ChartDataRequest.java` - Конфигурация графика
  - [ ] `ChartDataResponse.java` - Данные + метаданные
  - [ ] Поддержка разных форматов графиков

### Задачи фронтенда

- [ ] **Сервис графиков**
  - [ ] `chartService.ts` - API вызовы
  - [ ] Хук `useChartData` с React Query
  - [ ] Хелперы построения запросов
  - [ ] Трансформеры ответов для Recharts

### Ожидаемый результат
Бэкенд может генерировать данные графиков для любой визуализации с фильтрами и агрегациями.

---

## Фаза 6: Компоненты визуализации

### Задачи фронтенда

- [ ] **Компоненты графиков** (используя Recharts)
  - [ ] `BarChart.tsx` - Столбчатая диаграмма (категориальная или временная)
  - [ ] `PieChart.tsx` - Круговая/кольцевая диаграмма
  - [ ] Поддержка множественных серий
  - [ ] Подсказки и легенды
  - [ ] Адаптивный размер
  - [ ] Цветовые темы

- [ ] **Панель конфигурации графиков**
  - [ ] Селектор колонок (ось X, ось Y, серии)
  - [ ] Селектор типа графика
  - [ ] Селектор функции агрегации
  - [ ] Селектор группировки по времени (для дат)

- [ ] **Панель фильтров**
  - [ ] Выбор диапазона дат
  - [ ] Категориальные фильтры (множественный выбор)
  - [ ] Слайдеры числового диапазона
  - [ ] Кнопки Применить/Сбросить

- [ ] **Страница дашборда**
  - [ ] Роут: `/dashboard/:datasetId`
  - [ ] Множественные графики в сеточной компоновке
  - [ ] Добавление/удаление виджетов графиков
  - [ ] Глобальные фильтры
  - [ ] Функциональность экспорта (PNG, CSV)

### Ожидаемый результат
Интерактивный дашборд с настраиваемыми графиками и фильтрами.

---

## Фаза 7: Доработка UI/UX

### Задачи фронтенда

- [ ] **Стилизация и компоновка**
  - [ ] Правильно реализовать Tailwind CSS
  - [ ] Создать переиспользуемые компоненты
  - [ ] `AppLayout.tsx` - Основная компоновка с боковой панелью
  - [ ] `Header.tsx` - Навигация
  - [ ] `Sidebar.tsx` - Навигация по датасетам

- [ ] **Маршрутизация**
  - [ ] Настроить React Router
  - [ ] Главная страница (`/`)
  - [ ] Страница датасетов (`/datasets`)
  - [ ] Статус загрузки (`/upload/:jobId`)
  - [ ] Страница дашборда (`/dashboard/:datasetId`)
  - [ ] Страница 404

- [ ] **Обработка ошибок**
  - [ ] Error boundaries
  - [ ] Toast уведомления
  - [ ] Состояния загрузки
  - [ ] Пустые состояния

- [ ] **Адаптивный дизайн**
  - [ ] Мобильные макеты
  - [ ] Оптимизация для планшетов
  - [ ] Оптимизация для десктопа

### Ожидаемый результат
Отшлифованный, профессионально выглядящий интерфейс с плавным UX.

---

## Фаза 8: Тестирование и оптимизация

### Задачи бэкенда

- [ ] **Модульные тесты**
  - [ ] Тесты слоя сервисов
  - [ ] Тесты репозиториев
  - [ ] Тесты определения типов
  - [ ] Тесты парсинга CSV

- [ ] **Интеграционные тесты**
  - [ ] Тесты контроллеров с MockMvc
  - [ ] Интеграционные тесты базы данных
  - [ ] End-to-end тест потока загрузки

- [ ] **Оптимизация производительности**
  - [ ] Добавление индексов базы данных
  - [ ] Оптимизация пакетных вставок
  - [ ] Добавление кэширования результатов запросов
  - [ ] Настройка пула соединений

### Задачи фронтенда

- [ ] **Тесты компонентов**
  - [ ] Тесты компонентов графиков
  - [ ] Тесты компонента загрузки
  - [ ] Тесты хуков

- [ ] **E2E тесты**
  - [ ] Тест потока загрузки
  - [ ] Тест создания дашборда
  - [ ] Тест применения фильтров

- [ ] **Производительность**
  - [ ] Разделение кода
  - [ ] Ленивая загрузка
  - [ ] Мемоизация
  - [ ] Оптимизация размера бандла

### Ожидаемый результат
Хорошо протестированное, производительное приложение.

---

## Фаза 9: Production развёртывание

### Задачи инфраструктуры

- [ ] **Production Docker настройка**
  - [ ] Multi-stage Dockerfiles для меньших образов
  - [ ] Nginx для production сборки фронтенда
  - [ ] Конфигурация на основе окружения
  - [ ] Health checks

- [ ] **Безопасность**
  - [ ] Конфигурация HTTPS
  - [ ] Правильная настройка CORS
  - [ ] Предотвращение SQL инъекций (использование параметризованных запросов)
  - [ ] Безопасность загрузки файлов (валидация типов, ограничение размера)
  - [ ] Rate limiting

- [ ] **Развёртывание**
  - [ ] Production docker-compose.yml
  - [ ] Управление переменными окружения
  - [ ] Бэкапы базы данных
  - [ ] Настройка логирования (ELK stack или аналог)
  - [ ] Мониторинг (Prometheus, Grafana)

- [ ] **Документация**
  - [ ] Документация API (Swagger/OpenAPI)
  - [ ] Руководство по развёртыванию
  - [ ] Руководство пользователя

### Ожидаемый результат
Production-ready приложение развёрнуто и мониторится.

---

## Будущие улучшения (опционально)

- [ ] **Аутентификация пользователей**
  - [ ] Spring Security + JWT
  - [ ] Регистрация/вход пользователей
  - [ ] Владение датасетами
  - [ ] Функциональность совместного использования

- [ ] **Продвинутые функции**
  - [ ] Больше типов графиков (Line, Scatter, Heatmap)
  - [ ] Шаблоны дашбордов
  - [ ] Запланированные отчёты
  - [ ] Экспорт данных (Excel, PDF)
  - [ ] Совместное использование дашбордов (публичные ссылки)

- [ ] **Обработка данных**
  - [ ] Трансформации колонок
  - [ ] Вычисляемые поля
  - [ ] Объединение данных
  - [ ] Сводные таблицы

- [ ] **Производительность**
  - [ ] Redis кэширование
  - [ ] Кэширование результатов запросов
  - [ ] Материализованные представления для больших датасетов
  - [ ] Фоновые задачи агрегации

---

## Краткая справка

### Порядок приоритетов
1. Фаза 1 (База данных) - Фундамент
2. Фаза 2 (Загрузка) - Основной функционал
3. Фаза 3 (Датасеты) - Управление данными
4. Фаза 5 (API графиков) - Бэкенд визуализации
5. Фаза 6 (Графики) - Фронтенд визуализации
6. Фаза 7 (UI/UX) - Доработка
7. Фаза 4 (WebSocket) - Желательно иметь
8. Фаза 8 (Тестирование) - Перед production
9. Фаза 9 (Развёртывание) - Production релиз

### Временные оценки (приблизительно)
- Фаза 1: 1-2 дня
- Фаза 2: 3-5 дней
- Фаза 3: 2-3 дня
- Фаза 4: 1-2 дня
- Фаза 5: 3-4 дня
- Фаза 6: 4-6 дней
- Фаза 7: 2-3 дня
- Фаза 8: 3-5 дней
- Фаза 9: 2-3 дня

**Итого: ~3-5 недель** для одного разработчика

### Ключевые зависимости
- OpenCSV (бэкенд)
- Recharts (фронтенд)
- React Query (фронтенд)
- Spring WebSocket (бэкенд)
- Flyway/Liquibase (бэкенд)

---

## Примечания

- Начните с Фазы 1 и 2 для работы основного функционала загрузки
- Фаза 4 (WebSocket) может быть выполнена позже - опрос работает нормально для MVP
- Делайте небольшие коммиты и часто тестируйте
- Используйте примеры данных в `data/` для тестирования
- Обращайтесь к `Full Stack Architecture Plan.md` для детальных архитектурных решений
